rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // USERS: 
    // - Un usuario puede leer cualquier perfil (para ver nombres/fotos de proveedores).
    // - Un usuario solo puede escribir/actualizar su propio perfil.
    match /users/{userId} {
      allow read;
      allow write, update: if request.auth.uid == userId;
    }
    
    // PROVIDERS (subcolección de users):
    // Un usuario solo puede gestionar su propia lista de proveedores.
     match /users/{userId}/providers/{providerId} {
        allow read, write, delete: if request.auth.uid == userId;
     }

    // CLIENTS: 
    // - Un proveedor puede gestionar sus propios clientes.
    // - Un cliente puede leer sus propios datos si conoce el ID del documento.
    match /clients/{clientId} {
      allow read, write, delete: if request.resource.data.userId == request.auth.uid;
    }
    
    // SERVICES:
    // - Cualquiera puede leer los servicios (son como un catálogo público).
    // - Solo el propietario puede crear, actualizar o eliminar sus servicios.
    match /services/{serviceId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth.uid == request.resource.data.userId;
    }

    // CASES:
    // Solo el proveedor del caso o el cliente del caso pueden leerlo.
    match /cases/{caseId} {
      // Esta regla es un placeholder, requeriría más detalle para producción
      // por ejemplo, guardar el `clientId` y `providerId` en el documento del caso.
      allow read, write: if request.auth != null; 
      
      // COMMENTS (subcolección de cases)
      // Cualquiera que pueda ver el caso, puede ver y añadir comentarios.
      match /comments/{commentId} {
         allow read, create: if request.auth != null;
      }
    }
    
  }
}
