rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users:
    // - Allow users to read and update their own profile.
    // - Allow authenticated users to look up other users by phone number (for adding to network).
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      allow list: if request.auth.uid != null; // Allows querying users
      
      // Providers subcollection (for clients)
      match /providers/{providerId} {
        allow read, write, delete: if request.auth.uid == userId;
      }
    }
    
    // Clients (for providers)
    // - Providers can manage their own list of clients.
    match /clients/{clientId} {
      allow read, write, delete: if request.auth.uid == request.resource.data.providerId;
    }

    // Services:
    // - Providers can manage their own services.
    // - Authenticated users can read/list services (needed for clients to browse).
    match /services/{serviceId} {
      allow create: if request.auth.uid == request.resource.data.userId;
      allow read, list, update, delete: if request.auth.uid != null;
    }

    // Cases:
    // - A case can be created by either the client or the provider.
    // - Once created, only the client or provider involved can read or update it.
    match /cases/{caseId} {
      allow create: if request.auth.uid == request.resource.data.clientId || request.auth.uid == request.resource.data.providerId;
      allow read, update, list: if request.auth.uid == resource.data.clientId || request.auth.uid == resource.data.providerId;
      allow delete: if request.auth.uid == resource.data.providerId;
      
      // Comments within a case
      match /comments/{commentId} {
        allow read, create: if request.auth.uid == resource.data.clientId || request.auth.uid == resource.data.providerId || request.auth.uid == request.resource.data.userId;
      }
    }
    
    // Invoices:
    // - Only client or provider involved can read them.
    // - Only provider can create/update/delete.
    match /invoices/{invoiceId} {
       allow read, list: if request.auth.uid == resource.data.clientId || request.auth.uid == resource.data.providerId;
       allow create, update, delete: if request.auth.uid == resource.data.providerId;
    }
  }
}
