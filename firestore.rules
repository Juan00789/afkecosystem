
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Reglas para la colección 'users'
    // Permite a cualquier usuario autenticado leer su propio perfil.
    // Permite a cualquier usuario autenticado actualizar su propio perfil.
    match /users/{userId} {
      allow read, update: if request.auth != null && request.auth.uid == userId;
      
      // Reglas para la subcolección 'providers'
      // Permite a un usuario gestionar su propia lista de proveedores.
      match /providers/{providerId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Reglas para la colección 'clients'
    // Permite a un proveedor crear, leer, actualizar y eliminar sus propios clientes.
    // Un usuario solo puede listar los clientes que le pertenecen.
    match /clients/{clientId} {
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow list: if request.auth != null && request.query.resource.data.userId == request.auth.uid;
    }
    
    // Reglas para la colección 'services'
    // Permite a un proveedor gestionar sus propios servicios.
    // Permite a cualquier usuario autenticado leer los servicios.
    match /services/{serviceId} {
      allow create, update, delete: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null;
    }

    // Reglas para la colección 'cases'
    // Permite leer y escribir si el usuario es el proveedor (userId) o el cliente (clientId).
    match /cases/{caseId} {
      allow read, write: if request.auth != null && (request.auth.uid == resource.data.providerId || request.auth.uid == resource.data.clientId);
      
      // Reglas para la subcolección de comentarios
      match /comments/{commentId} {
         allow read, write: if request.auth != null; // Se podría restringir más si fuera